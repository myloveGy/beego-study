{{template "./Layout/header.tpl" .}}	
<div class="row-fluid">
    <div class="box span12">
        <!--前面导航信息-->
        <div class="box-header" data-original-title="">
            <h2>
                <i class="icon-desktop"></i>
                <span class="break"></span>
            </h2>
            <div class="box-icon">
                <a title="添加" href="javascript:myTable.insert()"> 
                    <i class="icon-plus"></i>
                </a>
                <a id="table-refresh" title="刷新" href="#" onclick="return myTable.search();"> 
                    <i class="icon-refresh"></i>
                </a>
                <a id="toggle-fullscreen" class="hidden-phone hidden-tablet" title="全屏" href="#"> 
                    <i class="icon-fullscreen"></i>
                </a>
                <a class="btn-minimize" title="隐藏" href="#"> 
                    <i class="icon-chevron-up"></i>
                </a>
                <a class="btn-close" title="删除" href="#"> 
                    <i class="icon-remove"></i>
                </a>
            </div>
        </div>
        <div class="box-content">
            <!--表格数据-->
            <table class="table table-striped table-bordered table-hover layer-photos-demo" id="showTable">
            </table>
        </div>
    </div>
</div>
{{template "./Layout/footer.tpl"}}
<script type="text/javascript" src="/static/js/layer/extend/layer.ext.js"></script>
<script type="text/javascript">
    var myTable = new MeTable({
        tableId:"showTable",
        baseUrl:"/image/save",
        formOptions:{
            "enctype":"multipart/form-data",
        },
    },{
        "aoColumns":[
            {"data":"Id", "title":"ID", "sName":"Id", "edit":{"type":"hidden"}, "search":{"type":"text"}},
            {"data":"Title", "sName":"Title", "title":"图片标题","edit":{"options":{"required":1, "rangelength":"[2, 50]"}}, "search":{"type":"text"}},
            {"data":"Desc", "sName":"Desc","title":"图片描述", "edit":{ "options":{"rangelength":"[2, 255]"}}},
            {"data":"Url", "sName":"Url", "title":"图片地址", "edit":{"type":"file", "options":{"rangelength":"[1,100]"}}, "createdCell":function(td, data, rowdatas, row, col){
                    var alt =  empty(rowdatas) ? '图片详情信息' : rowdatas.Title;
                    $(td).html('<img width="100px" layer-src="' + data + '" src="' + data + '" alt="' + alt + '" onclick="myTable.seeImage(' + row + ');" />')
            }},
            {"data":"Type", "sName":"Type","title":"图片类型","value":{"1":"轮播图", "2":"广告图"}, "createdCell":function(td, data, rowdatas, row, col){
                var str = data == 1 ? '轮播图' : '广告图';
                $(td).html(str);
            }, "edit":{"type":"radio","default": 1, "options":{"required":1, "number":1}}, "search":{"type":"select", }},
            {"data":"Status", "sName":"Status","title":"状态","value":{"1":"启用", "0":"停用"}, "createdCell":statusToString, "edit":{"type":"radio","default": 1, "options":{"required":1, "number":1}}, "search":{"type":"select", }},
            {"data":"Sort","sName":"Sort", "title":"排序", "edit":{"options":{"required":1, "number":1, "value":100}}},
            {"data":"CreateTime", "sName":"CreateTime","title":"创建时间", "createdCell":dateTimeString, edit:{type:'hidden'}},
            {"data":"UpdateTime", "sName":"UpdateTime", "title":"修改时间", "createdCell":dateTimeString, edit:{type:'hidden'}},
            {"data":"CreateId", "sName":"CreateId", "title":"创建者ID", edit:{type:'hidden'}},
            {"data":"UpdateId", "sName":"UpdateId", "title":"修改者ID", edit:{type:'hidden'}},
            {"data": null, "title":"操作", "bSortable":false, "width":'120px', "createdCell":setOperate}
        ],

        "columnDefs":[{"targets":[9,10], "visible":false}],
    });

    myTable.seeImage = function(row) {
        var data = this.table.data()[row];
        layer.photos({
            photos: {
                "title": data.Title,    // 相册标题
                "id": 1,                // 相册id
                "start": 0,             // 初始显示的图片序号，默认0
                "data": [               //  相册包含的图片，数组格式
                    {
                        "alt": data.Title,
                        "pid": data.Id,     // 图片id
                        "src": data.Url,    // 原图地址
                        "thumb": data.Url   // 缩略图地址
                    }
                ]
            }
        });
    }

	// 加载完成
	$(function(){
		// 初始化表格
		myTable.init();

        // 图片上传处理
        $('.fileUpload').fileupload({
            dataType: 'json',
            url: '/image/fileupload',
            // 上传之前的操作
            beforeSend:function(e, data) {
                var arr = verifyUpload(data, 200000000, undefined, $('input[name=Url]').val());
                // 上传存在错误
                if ( ! arr[0])
                {
                    $('.fileUpload').next('span:first').html('未选择文件');
                    layer.msg(arr[1], {time:1000, icon:5})
                    return false;
                }
            },
            // 上传成功
            success: function(json)
            {
                if (json.Status == 1)
                {
                    layer.msg(json.Message, {time:1000, icon:6, end:function(){
                        $('.fileUpload').removeAttr("required").next('span:first').html(json.Data);
                        $('.fileUpload').parent().find('input[type=hidden]').val(json.Data);
                    }})

                    return false;
                }

                $('.fileUpload').attr('required', 1)
                layer.msg(json.Message, {time:1000, icon:5})
            }
        });
	})
</script>